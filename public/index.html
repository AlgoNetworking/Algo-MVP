<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PediAlgo - dashboard</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PediAlgo</h1>
            <div class="subtitle">Sistema Automatizado de Gest√£o de Pedidos</div>
            
            <div class="user-info-bar" style="margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 20px;">
                <div class="user-info" style="background: rgba(255,255,255,0.2); padding: 8px 20px; border-radius: 20px; display: flex; align-items: center; gap: 10px;">
                    <span class="user-avatar" style="width: 32px; height: 32px; background: white; color: #F0B513; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;" id="userAvatar">U</span>
                    <span class="user-name" style="color: white; font-weight: 600;" id="userName">Usu√°rio</span>
                </div>
                <button class="logout-btn" onclick="logout()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; transition: background 0.3s;">
                    üö™ Sair
                </button>
            </div>
            
            <div class="status-bar">
                <span id="connectionStatus" class="status-badge offline">Desconectado</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="bot">Controles do Bot</button>
            <!---<button class="tab" data-tab="database">Pedidos do Banco</button> -->
            <button class="tab" data-tab="user-orders">Pedidos por Usu√°rio</button>
            <button class="tab" data-tab="clients">Gerenciar Clientes</button>
            <button class="tab" data-tab="products">Gerenciar Produtos</button>
            <button class="tab" data-tab="notifications">Notifica√ß√µes
                <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
            </button>
            <button class="tab" data-tab="config">Configura√ß√µes</button>
        </div>

        <!-- Bot Controls Tab -->
        <div id="bot" class="tab-content active">
            <div class="grid-2">
                <!-- UPDATED: Bot Controls Panel - Clean UI with single button -->
                <div class="panel">
                    <h2>üéõÔ∏è Controles do Bot</h2>
                    <div class="controls">
                        <!-- Folder selection -->
                        <div class="form-group">
                            <label for="folderSelect">üìÅ Selecionar Pastas para Mensagens:</label>
                            <select id="folderSelect" class="form-control" multiple size="5" style="height: auto;">
                                <!-- Folders will be populated by JavaScript -->
                            </select>
                            <small style="display: block; margin-top: 5px; color: #7f8c8d;">
                                Mantenha Ctrl (ou Cmd) pressionado para selecionar m√∫ltiplas pastas
                            </small>
                            <button class="btn btn-sm btn-primary" style="margin-top: 10px;" onclick="confirmFolderSelection()">
                                ‚úÖ Confirmar Sele√ß√£o
                            </button>
                            <div id="selectedFoldersInfo" style="display: none; margin-top: 10px; padding: 10px; background: #e9f7ef; border-radius: 8px; border-left: 4px solid #27ae60;">
                                <strong>üìÅ Pastas Selecionadas:</strong>
                                <div id="selectedFoldersList" style="margin-top: 5px;"></div>
                            </div>
                        </div>
                        
                        <!-- Connection buttons -->
                        <button id="connectBtn" class="btn btn-primary">
                            üì± Conectar WhatsApp
                        </button>
                        <button id="disconnectBtn" class="btn btn-danger" disabled>
                            üîå Desconectar
                        </button>
                        
                        <!-- UPDATED: Single button to open bulk message controls -->
                        <button id="sendBulkBtn" class="btn btn-success" disabled onclick="showBulkMessageOptions()">
                            üì§ Enviar Mensagens para seus Clientes
                        </button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="sessionCount">0</div>
                            <div class="stat-label">Sess√µes Ativas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="messageCount">0</div>
                            <div class="stat-label">Mensagens Hoje</div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2>üì± Autentica√ß√£o WhatsApp</h2>
                    <div id="qrContainer" class="qr-container">
                        <p class="qr-placeholder">Conecte o bot para exibir o QR Code</p>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>üìã Logs do Sistema</h2>
                <div id="logs" class="logs"></div>
            </div>
        </div>

        <!-- Other tabs remain the same... -->
        <!-- Database Tab -->
        <div id="database" class="tab-content">
            <div class="grid-2">
                <div class="panel">
                    <h2>üìä Pedidos Totais</h2>
                    <div class="controls-inline">
                        <button class="btn btn-sm btn-primary" onclick="refreshOrders()">
                            üîÑ Atualizar
                        </button>
                        <button class="btn btn-sm btn-success" id="autoRefreshBtn" onclick="toggleAutoRefresh()">
                            üîÅ Auto: OFF
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="clearDatabase()">
                            üóëÔ∏è Limpar Todos
                        </button>
                        <button class="btn btn-info" onclick="downloadExcel()">
                            üìÑ Baixar Totais (Arquivo Excel)
                        </button>
                    </div>
                    <div id="ordersTable" class="table-container"></div>
                </div>

                <div class="panel">
                    <h2>üìà Estat√≠sticas</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalProducts">0</div>
                            <div class="stat-label">Produtos Diferentes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalQuantity">0</div>
                            <div class="stat-label">Total de Itens</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Orders Tab -->
        <div id="user-orders" class="tab-content">
            <div class="panel">
                <h2>üë• Pedidos por Usu√°rio</h2>
                <div class="controls-inline">
                    <button class="btn btn-sm btn-primary" onclick="refreshUserOrders()">
                        üîÑ Atualizar
                    </button>
                    <button class="btn btn-sm btn-success" id="autoRefreshUserBtn" onclick="toggleAutoRefreshUser()">
                        üîÅ Auto: OFF
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="clearUserOrders()">
                        üóëÔ∏è Limpar Todos
                    </button>
                    <button class="btn btn-info" onclick="downloadOrdersTxt()">
                        üìÑ Baixar Pedidos (Arquivo de texto)
                    </button>
                </div>
                <div id="userOrdersContainer"></div>
            </div>

            <div class="panel">
                <h2>‚ûï Adicionar Pedido Manual</h2>
                <form id="manualOrderForm" class="form">
                    <div class="form-group">
                        <label>Telefone:</label>
                        <input type="text" id="manualPhone" placeholder="+55 85 9999-9999" required>
                    </div>
                    <div class="form-group">
                        <label>Nome:</label>
                        <input type="text" id="manualName" placeholder="Nome do cliente" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Pedido:</label>
                        <select id="manualOrderType">
                            <option value="normal">Normal</option>
                            <option value="quilo">Quilo</option>
                            <option value="dosado">Dosado</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Pedido:</label>
                        <textarea id="manualMessage" placeholder="Ex: 4 mangas e 2 maracuj√°s" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Adicionar Pedido</button>
                </form>
            </div>
        </div>

        <!-- Clients Tab -->
        <div id="clients" class="tab-content">
            <div class="panel">
                <h2>üë• Gerenciar Clientes</h2>
                <div id="clientsList" class="clients-list"></div>
            </div>
        </div>

        <!-- Products Tab -->
        <div id="products" class="tab-content">
            <div class="panel">
                <h2>üì¶ Gerenciar Produtos</h2>
                <button class="btn btn-primary" onclick="addProduct()">‚ûï Adicionar Produto</button>
                <div id="productsList" class="products-list"></div>
            </div>
        </div>

        <!-- Notifications Tab -->
        <div id="notifications" class="tab-content">
            <div class="panel">
                <h2>üîî Notifica√ß√µes Pendentes</h2>
                <div class="controls-inline">
                    <button id="clearAllNotificationsBtn" class="btn btn-sm btn-warning">
                        ‚úÖ Marcar Todas como Lidas
                    </button>
                </div>
                <div id="notificationsContainer" class="notifications-container">
                    <div class="empty-state">Nenhuma notifica√ß√£o</div>
                </div>
            </div>
        </div>
                
        <!-- Configuration Tab -->
        <div id="config" class="tab-content">
            <div class="panel" style="display:flex; align-items:center; justify-content:space-between;">
                <h2>‚öôÔ∏è Configura√ß√µes</h2>
                <button id="saveConfigBtn" class="btn btn-primary">üíæ Salvar</button>
            </div>

            <div class="panel">
                <h3>Op√ß√µes do Bot</h3>

                <div class="form-group" style="margin-top: 15px;">
                    <label style="font-weight:700; margin-bottom:8px;">üë§ Chamar usu√°rios pelo nome</label>
                    <div style="display:flex; align-items:center; gap:12px; margin-top:8px;">
                        <button id="toggleCallByName" class="toggle-btn"></button>
                        <span id="toggleCallByNameLabel" class="toggle-status">Ativado</span>
                    </div>
                    <small style="display:block; margin-top:8px; color:#7f8c8d;">
                        Quando desativado, o bot n√£o usar√° o nome dos usu√°rios nas mensagens.
                    </small>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label style="font-weight:700; margin-bottom:8px;">üìã Responder mensagens</label>
                    <div style="display:flex; align-items:center; gap:12px; margin-top:8px;">
                        <button id="toggleInterpretation" class="toggle-btn"></button>
                        <span id="toggleInterpretationLabel" class="toggle-status">Ativado</span>
                    </div>
                    <small style="display:block; margin-top:8px; color:#7f8c8d;">
                        Quando desativado, o bot n√£o responder√° √†s mensagens dos usu√°rios.
                    </small>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label style="font-weight:700; margin-bottom:8px;">üë§ Responder mensagens de pessoas desconhecidas</label>
                    <div style="display:flex; align-items:center; gap:12px; margin-top:8px;">
                        <button id="toggleUnknownUsers" class="toggle-btn"></button>
                        <span id="toggleUnknownUsersLabel" class="toggle-status">Ativado</span>
                    </div>
                    <small style="display:block; margin-top:8px; color:#7f8c8d;">
                        Quando desativado, o bot n√£o responder√° √†s mensagens de pessoas desconhecidas (aquelas que n√£o est√£o em nenhuma das pastas selecionadas).
                    </small>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label style="font-weight:700; margin-bottom:8px;">Produtos com pre√ßo</label>
                    <div style="display:flex; align-items:center; gap:12px; margin-top:8px;">
                        <button id="toggleProductsHavePrice" class="toggle-btn"></button>
                        <span id="toggleProductsHavePriceLabel" class="toggle-status">Ativado</span>
                    </div>
                    <small style="display:block; margin-top:8px; color:#7f8c8d;">
                        Quando desativado, os produtos poder√£o ser criados sem pre√ßo e o resumo do pedido n√£o mostrar√° pre√ßos.
                    </small>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label style="font-weight:700; margin-bottom:8px;">Tolerar erros de digita√ß√£o dos clientes</label>
                    <div style="display:flex; align-items:center; gap:12px; margin-top:8px;">
                        <button id="toggleTolerateMisspellings" class="toggle-btn"></button>
                        <span id="toggleTolerateMisspellingsLabel" class="toggle-status">Ativado</span>
                    </div>
                    <small style="display:block; margin-top:8px; color:#7f8c8d;">
                        Quando desativado, o sistema n√£o tolerar√° erros de digita√ß√£o dos clientes ao pedir produtos.
                    </small>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label style="font-weight:700; margin-bottom:8px;">Mostrar Chave PIX no Resumo do Pedido</label>
                    <div style="display:flex; align-items:center; gap:12px; margin-top:8px;">
                        <button id="toggleShowPIXKey" class="toggle-btn"></button>
                        <span id="toggleShowPIXKeyLabel" class="toggle-status">Ativado</span>
                    </div>
                    <small style="display:block; margin-top:8px; color:#7f8c8d;">
                        Quando desativado, o resumo do pedido n√£o mostrar√° a chave PIX.
                    </small>
                </div>
                <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                            üí≥ Chave PIX
                        </label>
                        <input type="text" id="PIXKeyInput" placeholder="Insira sua chave PIX aqui"
                                style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
                        <small style="display: block; margin-top: 5px; color: #7f8c8d;">
                            Esta chave aparecer√° no resumo do pedido para que seus clientes possam fazer o pagamento 
                            e quando a op√ß√£o "Mostrar Chave PIX no Resumo do Pedido" estiver ativada.
                            Tamb√©m ser√° mostrada como op√ß√£o no menu dos clientes.
                        </small>
                    </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label style="font-weight:700; margin-bottom:8px;">‚è±Ô∏è Intervalo entre lembretes (minutos)</label>
                    <div style="display:flex; align-items:center; gap:12px; margin-top:8px;">
                        <!-- you asked for a textarea ‚Äî we use a single-line textarea but treat it like an integer-only input via JS -->
                        <textarea id="reminderIntervalInput" rows="1" style="min-height: 20px; width:50px; padding:6px; font-family:inherit; resize:none;"
                        placeholder="30"></textarea>
                        <span id="reminderIntervalLabel" class="toggle-status"></span>
                    </div>
                    <small style="display:block; margin-top:8px; color:#7f8c8d;">
                        Digite um n√∫mero entre 1 e 90.
                    </small>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label style="font-weight:700; margin-bottom:8px;">üìí Apresentar dados do seu neg√≥cio para seus clientes (como tabelas de pre√ßo, hor√°rios de funcionamento, etc)</label>
                    <div style="display:flex; align-items:center; gap:12px; margin-top:8px;"></div>
                        <!-- Title Field -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                                üìã T√≠tulo
                            </label>
                            <input type="text" id="businessInfoTitle" 
                                    style="width: 100%; padding: 10px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;"
                                    placeholder="Ex: Tabela de Pre√ßos, Hor√°rios de Funcionamento, Sobre Nosso Neg√≥cio">
                            <small style="display: block; margin-top: 5px; color: #7f8c8d;">
                                Este t√≠tulo aparecer√° como op√ß√£o 5 no menu dos clientes
                            </small>
                        </div>
                        
                        <!-- File Upload Section -->
                        <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border: 2px dashed #9DB044; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50;">
                                üìé Anexar Arquivo (Opcional)
                            </label>
                            <input type="file" id="businessInfoFile" 
                                    accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" 
                                    style="width: 100%; padding: 8px; border: 1px solid #e9ecef; border-radius: 5px; cursor: pointer;">
                            <small style="display: block; margin-top: 5px; color: #7f8c8d;">
                                Imagens, PDFs, documentos do Office s√£o aceitos
                        </small>
                        
                        <!-- File Preview -->
                        <div id="businessInfoFilePreview" style="display: none; margin-top: 10px; padding: 10px; background: white; border: 1px solid #e9ecef; border-radius: 5px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                            <span id="businessInfoFileName" style="flex: 1; color: #2c3e50; font-weight: 600;"></span>
                            <button type="button" class="btn btn-sm btn-danger" onclick="clearBusinessInfoFile()" style="padding: 4px 8px;">
                                ‚ùå Remover
                            </button>
                            </div>
                            <img id="businessInfoImagePreview" style="display: none; max-width: 100%; max-height: 200px; margin-top: 10px; border-radius: 5px;">
                        </div>
                        </div>
                        
                        <!-- Message Text -->
                        <textarea id="businessInfoText" 
                        style="width: 100%; min-height: 150px; padding: 10px; border: 2px solid #e9ecef; 
                                border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                        placeholder="Digite sua mensagem aqui... (opcional se anexou arquivo)"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Modal Dialog System -->
    <div id="modalOverlay" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Confirma√ß√£o</h3>
            </div>
            <div class="modal-body">
                <p id="modalMessage">Voc√™ tem certeza?</p>
            </div>
            <div class="modal-footer">
                <button id="modalCancelBtn" class="btn btn-sm btn-danger">N√£o</button>
                <button id="modalConfirmBtn" class="btn btn-sm btn-success">Sim</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="/js/app.js"></script>
</body>
</html>